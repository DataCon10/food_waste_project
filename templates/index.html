<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Impact Summary & Recipes</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600&display=swap" rel="stylesheet">
  <style>
    /* Global Styles */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #80deea);
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: 50px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 2.8rem;
      color: #00796b;
    }
    h2 {
      font-size: 2rem;
      color: #004d40;
    }
    
    /* Stats Section */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .stat {
      background: #e0f2f1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .stat:hover {
      transform: translateY(-5px);
    }
    .stat .label {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #004d40;
    }
    .stat .value {
      font-size: 1.8rem;
      color: #00796b;
    }
    
    /* Recipe Dropdown */
    .dropdown-container {
      text-align: center;
      margin-bottom: 40px;
    }
    select {
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
      width: 100%;
      max-width: 400px;
    }
    
    /* Recipe Details */
    .recipe-details {
      background: #f1f8e9;
      border: 1px solid #c5e1a5;
      border-radius: 8px;
      padding: 20px;
      margin: 0 auto 40px;
      max-width: 600px;
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .recipe-details img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .recipe-details h3 {
      margin-top: 0;
      color: #00796b;
      font-size: 1.8rem;
    }
    .recipe-details p {
      font-size: 1rem;
      margin-bottom: 10px;
    }
    .recipe-details .label {
      font-weight: 600;
      color: #004d40;
    }
    
    /* Tag-based Ingredient Input */
    .tag-input-section {
      text-align: center;
      margin-bottom: 40px;
    }
    .tag-input-container {
      display: inline-block;
      width: 80%;
      max-width: 500px;
      border: 1px solid #ccc;
      border-radius: 30px;
      padding: 10px 20px;
      background: #fff;
      position: relative;
    }
    .tag {
      display: inline-block;
      background: #00796b;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      margin: 5px;
      font-size: 0.9rem;
    }
    .tag .remove-tag {
      margin-left: 6px;
      cursor: pointer;
    }
    .tag-input-container input {
      border: none;
      outline: none;
      font-size: 1rem;
      padding: 8px;
      min-width: 150px;
    }
    .search-button {
      margin-top: 20px;
      padding: 12px 30px;
      font-size: 1rem;
      border: none;
      background: #00796b;
      color: #fff;
      border-radius: 30px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .search-button:hover {
      background: #004d40;
    }
    
    /* Autocomplete Suggestions */
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 100;
    }
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f1f1f1;
    }
    
    /* Search Results */
    .recipe-card {
      background: #f9fbe7;
      border: 1px solid #dce775;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .recipe-card:hover {
      transform: translateY(-3px);
    }
    .recipe-card img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .recipe-card h3 {
      margin: 10px 0;
      color: #33691e;
    }
    .recipe-card p {
      font-size: 0.95rem;
      margin: 5px 0;
    }
    .recipe-card .label {
      font-weight: 600;
      color: #33691e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Impact Summary</h1>
    <div class="stats">
      <div class="stat">
        <span class="label">Overall CO₂ Savings</span>
        <span class="value">{{ summary.co2_savings }} kg</span>
      </div>
      <div class="stat">
        <span class="label">Overall Money Saved</span>
        <span class="value">${{ summary.money_saved }}</span>
      </div>
      <div class="stat">
        <span class="label">Recipes Used</span>
        <span class="value">{{ summary.recipes_used }}</span>
      </div>
    </div>
    
    <!-- Dropdown for Recipe Selection -->
    <h2>Select a Recipe</h2>
    <div class="dropdown-container">
      <select id="recipeDropdown">
        <option value="">-- Choose a Recipe --</option>
        {% for recipe in recipes %}
          <option value="{{ loop.index0 }}">{{ recipe.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="recipeDetails" class="recipe-details">
      <img id="recipeImage" src="" alt="Recipe Image">
      <h3 id="recipeName"></h3>
      <p id="recipeDescription"></p>
      <p><span class="label">CO₂ Savings:</span> <span id="recipeCO2"></span> kg</p>
      <p><span class="label">Money Saved:</span> $<span id="recipeMoney"></span></p>
    </div>
    
    <!-- Tag-based Ingredient Input Section with Autocomplete -->
    <h2>What Leftovers Do You Have?</h2>
    <div class="tag-input-section">
      <div class="tag-input-container" id="tagInputContainer">
        <input type="text" id="ingredientTagInput" placeholder="Type an ingredient and press Enter">
        <div id="suggestions" class="suggestions" style="display:none;"></div>
      </div>
      <button class="search-button" id="searchButtonTags">Search Recipes</button>
    </div>
    <div id="searchResults"></div>
  </div>
  
  <script>
    // Dropdown functionality for recipe selection
    const recipes = {{ recipes | tojson }};
    const dropdown = document.getElementById('recipeDropdown');
    const detailsDiv = document.getElementById('recipeDetails');
    const recipeName = document.getElementById('recipeName');
    const recipeDescription = document.getElementById('recipeDescription');
    const recipeCO2 = document.getElementById('recipeCO2');
    const recipeMoney = document.getElementById('recipeMoney');
    const recipeImage = document.getElementById('recipeImage');

    dropdown.addEventListener('change', function() {
      const selectedIndex = dropdown.value;
      if (selectedIndex === "") {
        detailsDiv.style.display = 'none';
      } else {
        const selectedRecipe = recipes[selectedIndex];
        recipeName.textContent = selectedRecipe.name;
        recipeDescription.textContent = selectedRecipe.description;
        recipeCO2.textContent = selectedRecipe.co2_savings;
        recipeMoney.textContent = selectedRecipe.money_saved;
        recipeImage.src = selectedRecipe.image;
        detailsDiv.style.display = 'block';
      }
    });

    // Tag Input & Autocomplete Functionality
    const tagInputContainer = document.getElementById('tagInputContainer');
    const ingredientTagInput = document.getElementById('ingredientTagInput');
    const suggestionsBox = document.getElementById('suggestions');
    let tags = [];
    
    // Build unique list of ingredients from all recipes
    const allIngredients = [...new Set(recipes.flatMap(recipe => recipe.ingredients.map(i => i.toLowerCase())))];
    
    function createTagElement(text) {
      const tagElem = document.createElement('span');
      tagElem.className = 'tag';
      tagElem.textContent = text;
      const removeIcon = document.createElement('span');
      removeIcon.className = 'remove-tag';
      removeIcon.textContent = ' ×';
      removeIcon.onclick = () => {
        tags = tags.filter(t => t !== text);
        tagInputContainer.removeChild(tagElem);
      };
      tagElem.appendChild(removeIcon);
      return tagElem;
    }
    
    // Autocomplete suggestions based on input
    ingredientTagInput.addEventListener('input', function() {
      const inputVal = ingredientTagInput.value.trim().toLowerCase();
      suggestionsBox.innerHTML = "";
      if (inputVal === "") {
        suggestionsBox.style.display = 'none';
        return;
      }
      const filtered = allIngredients.filter(ing => ing.startsWith(inputVal) && !tags.includes(ing));
      if (filtered.length > 0) {
        filtered.forEach(suggestion => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = suggestion;
          item.onclick = () => {
            if (!tags.includes(suggestion)) {
              tags.push(suggestion);
              const tagElem = createTagElement(suggestion);
              tagInputContainer.insertBefore(tagElem, ingredientTagInput);
            }
            ingredientTagInput.value = "";
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = 'none';
          };
          suggestionsBox.appendChild(item);
        });
        suggestionsBox.style.display = 'block';
      } else {
        suggestionsBox.style.display = 'none';
      }
    });
    
    // Listen for Enter key to add a tag if not selecting suggestion
    ingredientTagInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && ingredientTagInput.value.trim() !== '') {
        e.preventDefault();
        const tagText = ingredientTagInput.value.trim().toLowerCase();
        if (!tags.includes(tagText)) {
          tags.push(tagText);
          const tagElem = createTagElement(tagText);
          tagInputContainer.insertBefore(tagElem, ingredientTagInput);
        }
        ingredientTagInput.value = "";
        suggestionsBox.innerHTML = "";
        suggestionsBox.style.display = 'none';
      }
    });
    
    // Search based on tags using the /search endpoint
    const searchButtonTags = document.getElementById('searchButtonTags');
    const searchResults = document.getElementById('searchResults');
    
    searchButtonTags.addEventListener('click', function() {
      if (tags.length === 0) {
        searchResults.innerHTML = "<p>Please add some ingredients first.</p>";
        return;
      }
      const ingredientsStr = tags.join(',');
      fetch(`/search?ingredients=${encodeURIComponent(ingredientsStr)}`)
        .then(response => response.json())
        .then(data => {
          if (data.length === 0) {
            searchResults.innerHTML = "<p>No matching recipes found.</p>";
          } else {
            let html = "";
            data.forEach(recipe => {
              html += `
                <div class="recipe-card">
                  <img src="${recipe.image}" alt="${recipe.name}">
                  <h3>${recipe.name}</h3>
                  <p>${recipe.description}</p>
                  <p><span class="label">CO₂ Savings:</span> ${recipe.co2_savings} kg</p>
                  <p><span class="label">Money Saved:</span> $${recipe.money_saved}</p>
                </div>
              `;
            });
            searchResults.innerHTML = html;
          }
        })
        .catch(error => {
          console.error("Error fetching recipes:", error);
          searchResults.innerHTML = "<p>Error fetching recipes. Please try again later.</p>";
        });
    });
  </script>
</body>
</html>
