<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Impact Summary & Recipes</title>
  <!-- Reference the CSS file from the static folder -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Impact Summary</h1>
    <div class="stats">
      <div class="stat">
        <span class="label">Overall CO₂ Savings</span>
        <span class="value">{{ summary.co2_savings }} kg</span>
      </div>
      <div class="stat">
        <span class="label">Overall Money Saved</span>
        <span class="value">${{ summary.money_saved }}</span>
      </div>
      <div class="stat">
        <span class="label">Recipes Used</span>
        <span class="value">{{ summary.recipes_used }}</span>
      </div>
    </div>
    
    <!-- Dropdown for Recipe Selection -->
    <h2>Select a Recipe</h2>
    <div class="dropdown-container">
      <select id="recipeDropdown">
        <option value="">-- Choose a Recipe --</option>
        {% for recipe in recipes %}
          <option value="{{ loop.index0 }}">{{ recipe.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="recipeDetails" class="recipe-details">
      <img id="recipeImage" src="" alt="Recipe Image">
      <h3 id="recipeName"></h3>
      <p id="recipeDescription"></p>
      <p><span class="label">CO₂ Savings:</span> <span id="recipeCO2"></span> kg</p>
      <p><span class="label">Money Saved:</span> $<span id="recipeMoney"></span></p>
    </div>
    
    <!-- Tag-based Ingredient Input Section with Autocomplete -->
    <h2>What Leftovers Do You Have?</h2>
    <div class="tag-input-section">
      <div class="tag-input-container" id="tagInputContainer">
        <input type="text" id="ingredientTagInput" placeholder="Type an ingredient and press Enter">
        <div id="suggestions" class="suggestions" style="display:none;"></div>
      </div>
      <button class="search-button" id="searchButtonTags">Search Recipes</button>
    </div>
    <div id="searchResults"></div>
  </div>

  <script>
    // Dropdown functionality for recipe selection
    const recipes = {{ recipes | tojson }};
    const dropdown = document.getElementById('recipeDropdown');
    const detailsDiv = document.getElementById('recipeDetails');
    const recipeName = document.getElementById('recipeName');
    const recipeDescription = document.getElementById('recipeDescription');
    const recipeCO2 = document.getElementById('recipeCO2');
    const recipeMoney = document.getElementById('recipeMoney');
    const recipeImage = document.getElementById('recipeImage');

    dropdown.addEventListener('change', function() {
      const selectedIndex = dropdown.value;
      if (selectedIndex === "") {
        detailsDiv.style.display = 'none';
      } else {
        const selectedRecipe = recipes[selectedIndex];
        recipeName.textContent = selectedRecipe.name;
        recipeDescription.textContent = selectedRecipe.description;
        recipeCO2.textContent = selectedRecipe.co2_savings;
        recipeMoney.textContent = selectedRecipe.money_saved;
        recipeImage.src = selectedRecipe.image;
        detailsDiv.style.display = 'block';
      }
    });

    // Tag Input & Autocomplete Functionality
    const tagInputContainer = document.getElementById('tagInputContainer');
    const ingredientTagInput = document.getElementById('ingredientTagInput');
    const suggestionsBox = document.getElementById('suggestions');
    let tags = [];
    
    // Build a unique list of ingredients from all recipes
    const allIngredients = [...new Set(recipes.flatMap(recipe => recipe.ingredients.map(i => i.toLowerCase())))];
    
    function createTagElement(text) {
      const tagElem = document.createElement('span');
      tagElem.className = 'tag';
      tagElem.textContent = text;
      const removeIcon = document.createElement('span');
      removeIcon.className = 'remove-tag';
      removeIcon.textContent = ' ×';
      removeIcon.onclick = () => {
        tags = tags.filter(t => t !== text);
        tagInputContainer.removeChild(tagElem);
      };
      tagElem.appendChild(removeIcon);
      return tagElem;
    }
    
    // Autocomplete suggestions based on input
    ingredientTagInput.addEventListener('input', function() {
      const inputVal = ingredientTagInput.value.trim().toLowerCase();
      suggestionsBox.innerHTML = "";
      if (inputVal === "") {
        suggestionsBox.style.display = 'none';
        return;
      }
      const filtered = allIngredients.filter(ing => ing.startsWith(inputVal) && !tags.includes(ing));
      if (filtered.length > 0) {
        filtered.forEach(suggestion => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = suggestion;
          item.onclick = () => {
            if (!tags.includes(suggestion)) {
              tags.push(suggestion);
              const tagElem = createTagElement(suggestion);
              tagInputContainer.insertBefore(tagElem, ingredientTagInput);
            }
            ingredientTagInput.value = "";
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = 'none';
          };
          suggestionsBox.appendChild(item);
        });
        suggestionsBox.style.display = 'block';
      } else {
        suggestionsBox.style.display = 'none';
      }
    });
    
    // Listen for Enter key to add a tag if not selecting suggestion
    ingredientTagInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && ingredientTagInput.value.trim() !== '') {
        e.preventDefault();
        const tagText = ingredientTagInput.value.trim().toLowerCase();
        if (!tags.includes(tagText)) {
          tags.push(tagText);
          const tagElem = createTagElement(tagText);
          tagInputContainer.insertBefore(tagElem, ingredientTagInput);
        }
        ingredientTagInput.value = "";
        suggestionsBox.innerHTML = "";
        suggestionsBox.style.display = 'none';
      }
    });
    
    // Search based on tags using the /search endpoint
    const searchButtonTags = document.getElementById('searchButtonTags');
    const searchResults = document.getElementById('searchResults');
    
    searchButtonTags.addEventListener('click', function() {
      if (tags.length === 0) {
        searchResults.innerHTML = "<p>Please add some ingredients first.</p>";
        return;
      }
      const ingredientsStr = tags.join(',');
      fetch(`/search?ingredients=${encodeURIComponent(ingredientsStr)}`)
        .then(response => response.json())
        .then(data => {
          if (data.length === 0) {
            searchResults.innerHTML = "<p>No matching recipes found.</p>";
          } else {
            let html = "";
            data.forEach(recipe => {
              html += `
                <div class="recipe-card">
                  <img src="${recipe.image}" alt="${recipe.name}">
                  <h3>${recipe.name}</h3>
                  <p>${recipe.description}</p>
                  <p><span class="label">CO₂ Savings:</span> ${recipe.co2_savings} kg</p>
                  <p><span class="label">Money Saved:</span> $${recipe.money_saved}</p>
                </div>
              `;
            });
            searchResults.innerHTML = html;
          }
        })
        .catch(error => {
          console.error("Error fetching recipes:", error);
          searchResults.innerHTML = "<p>Error fetching recipes. Please try again later.</p>";
        });
    });
  </script>
</body>
</html>
